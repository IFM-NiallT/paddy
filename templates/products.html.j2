<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PADDY - {{ category.Description }} Products</title>
    <!-- Critical Meta Tags -->
    <meta name="description" content="PADDY: Product Attribute Designer Deployment for efficient product management and category browsing">
    <meta name="keywords" content="product management, inventory, categories, IFM, product attributes">
    <meta name="author" content="IFM">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="{{ url_for('static', filename='img/ifm_logo.png') }}" as="image">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" media="all">
    <link href="https://fonts.googleapis.com/css2?family=Liter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Modular CSS Import -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    <!-- Web Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Liter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- No-JS Fallback Styles -->
    <noscript>
      <style>
        .js-required { display: none; }
        .no-js-message { display: block; }
      </style>
    </noscript>
  </head>
<body>
  <!-- Accessibility Message for No JavaScript -->
  <div class="no-js-message message-accessibility" style="display:none;">
    <p class="message-text">JavaScript is required for full functionality. Please enable JavaScript in your browser.</p>
  </div>
  <header>
    <nav class="navbar navbar-expand-lg" aria-label="Main Navigation">
        <div class="container-fluid px-4">
            <div class="nav-brand-container d-flex align-items-center">
                <img
                    src="{{ url_for('static', filename='img/ifm_logo.png') }}"
                    alt="IFM logo"
                    class="logo me-2"
                    id="ifmLogo"
                    loading="lazy"
                >
                <a
                    class="navbar-brand"
                    href="{{ url_for('index') }}"
                    id="paddyText"
                    aria-label="PADDY Home"
                >
                    PADDY
                </a>
            </div>
            <div class="d-flex gap-2">
                <button
                    class="btn-uni"
                    onclick="exportTableToCSV()"
                    aria-label="Export current table to CSV"
                >
                    Export to CSV
                </button>
                <button
                    class="btn-uni"
                    onclick="window.location.href='/'"
                    aria-label="Return to Categories"
                >
                    Back to Categories
                </button>
            </div>
        </div>
    </nav>
</header>
<main class="content-wrapper" id="main-content" role="main" tabindex="-1">
  <!-- Search Container -->
<section class="search-container">
  <div class="search-wrapper">
    <label for="productSearch" class="visually-hidden">
      Search products by code or description
    </label>
    <input 
      type="search" 
      class="search-input" 
      id="productSearch" 
      placeholder="Search products..."
      aria-describedby="productSearchHelp"
      autocomplete="off"
    >
  </div>
</section>
  
  <!-- Products Container -->
  <section class="table-container">
    <div class="table-responsive">
      <!-- Header with Category Info and Pagination -->
      <header class="section-header">
        <h4>
          {{ category.Description }} ({{ category.Code }})
        </h4>
        
        <div class="pagination-container">
          {% if products.CurrentPage > 1 %}
            <a href="{{ url_for('products', category_id=category.ID, page=1, sort=current_sort) }}" class="pagination-arrow first-page" aria-label="Skip to first page">⏮️</a>
            <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage-1, sort=current_sort) }}" class="pagination-arrow prev-page" aria-label="Previous page">⬅️</a>
          {% endif %}
          
          {% set start_item = (products.CurrentPage - 1) * products.ItemsPerPage + 1 %}
          {% set end_item = [products.CurrentPage * products.ItemsPerPage, products.TotalCount] | min %}
          <span class="pagination-info">{{ start_item }}-{{ end_item }}/{{ products.TotalCount }}</span>
          
          {% if products.CurrentPage < products.TotalPages %}
            <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage+1, sort=current_sort) }}" class="pagination-arrow next-page" aria-label="Next page">➡️</a>
            <a href="{{ url_for('products', category_id=category.ID, page=products.TotalPages, sort=current_sort) }}" class="pagination-arrow last-page" aria-label="Skip to last page">⏭️</a>
          {% endif %}
        </div>
      </header>

      <!-- Table Content -->
      <table class="table products-table">
        <thead>
          <tr>
            <th class="{{ 'sort-column ' + ('asc' if current_sort == 'Code[asc]' else 'dsc' if current_sort == 'Code[dsc]' else '') }}">
              {% set current_direction = 'asc' if current_sort == 'Code[asc]' else 'dsc' if current_sort == 'Code[dsc]' else 'asc' %}
              {% set next_direction = 'dsc' if current_direction == 'asc' else 'asc' %}
              <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='Code[' + next_direction + ']') }}">Code</a>
              <div class="resizer" data-column="0"></div>
            </th>

            <th class="{{ 'sort-column ' + ('asc' if current_sort == 'Description[asc]' else 'dsc' if current_sort == 'Description[dsc]' else '') }}">
              {% set current_direction = 'asc' if current_sort == 'Description[asc]' else 'dsc' if current_sort == 'Description[dsc]' else 'asc' %}
              {% set next_direction = 'dsc' if current_direction == 'asc' else 'asc' %}
              <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='Description[' + next_direction + ']') }}">Product Name</a>
              <div class="resizer" data-column="1"></div>
            </th>

            {% for field in active_fields %}
            <th class="field-{{ field.field }} {{ 'sort-column ' + ('asc' if current_sort == field.field + '[asc]' else 'dsc' if current_sort == field.field + '[dsc]' else '') }}">
              {% set current_direction = 'asc' if current_sort == field.field + '[asc]' else 'dsc' if current_sort == field.field + '[dsc]' else 'asc' %}
              {% set next_direction = 'dsc' if current_direction == 'asc' else 'asc' %}
              <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort=field.field + '[' + next_direction + ']') }}">{{ field.display }}</a>
              <div class="resizer" data-column="{{ loop.index + 1 }}"></div>
            </th>
            {% endfor %}

            <th>Images<div class="resizer" data-column="{{ active_fields|length + 2 }}"></div></th>
            <th>Web Status<div class="resizer" data-column="{{ active_fields|length + 3 }}"></div></th>
            <th>Actions<div class="resizer" data-column="{{ active_fields|length + 4 }}"></div></th>
          </tr>
        </thead>

        <tbody>
          {% for product in products.Data %}
          <tr class="product-row" data-product-id="{{ product.ID }}">
            <td>{{ product.Code }}</td>
            <td data-full-text="{{ product.Description }}">{{ product.Description }}</td>
            {% for field in active_fields %}
            <td data-full-text="{{ product[field.field] if product[field.field] else '' }}">
              {{ product[field.field] if product[field.field] else '' }}
            </td>
            {% endfor %}
            <td>{{ product.ImageCount|round|int if product.ImageCount is number else '' }}</td>
            <td>
              {% set ecommerce_status = product.ECommerceSettings.ECommerceStatus if product.ECommerceSettings and 'ECommerceStatus' in product.ECommerceSettings else None %}
              {% set is_available = (ecommerce_status.Value == 0 or ecommerce_status.Name == 'Enabled') if ecommerce_status is mapping else false %}
              <span class="web-status-cell {{ 'available' if is_available else 'not-available' }}">
                {{ 'Available' if is_available else 'Not Available' }}
              </span>
            </td>
            <td>
              <button 
                class="btn-uni" 
                data-product-id="{{ product.ID }}" 
                aria-label="Edit product {{ product.Code }}"
              >
                Edit
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if products.Data|length == 0 %}
      <div class="table-empty-state">
        No products found in this category.
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Edit Product Popup -->
  <div class="modal-overlay" id="editFormOverlay"></div>
  <div class="modal" id="editProductForm" role="dialog" aria-labelledby="editFormTitle" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="editFormTitle" class="modal-title">
          Edit Product: <span id="popupProductCode"></span>
        </h2>
        <button type="button" class="close-button" onclick="closeEditForm()" aria-label="Close edit form">X</button>
      </div>
      
      <div class="modal-body">
        <form id="editProductFormContainer">
          <input type="hidden" id="popupProductId" name="product_id">
          
          <div id="errorContainer" class="alert alert-destructive" style="display: none;" role="alert">
            <div class="alert-message"></div>
          </div>
          <div id="successContainer" class="alert alert-success" style="display: none;" role="alert">
            <div class="alert-message"></div>
          </div>
          
          <div class="form-layout form-grid">
            <!-- Left Column: Static Fields -->
            <div class="form-column form-column-static">
              <!-- Product Name -->
              <div class="form-group">
                <label for="popupProductName">Product Name</label>
                <small id="productNameHelp" class="form-text">Display name (from product description)</small>
                <div id="popupProductName" class="form-control readonly-input" aria-describedby="productNameHelp"></div>
              </div>
              
              <!-- Extended Description -->
              <div class="form-group">
                <label for="popupExtendedDescription">Extended Description</label>
                <small id="extendedDescriptionHelp" class="form-text">Additional product details</small>
                <textarea
                  id="popupExtendedDescription"
                  name="extended_description"
                  class="form-control"
                  rows="4"
                  aria-describedby="extendedDescriptionHelp"
                ></textarea>
              </div>
              
              <!-- Image Count -->
              <div class="form-group">
                <label for="popupImageCount">Image Count</label>
                <small id="imageCountHelp" class="form-text">Total number of images for this product</small>
                <input
                  type="text"
                  id="popupImageCount"
                  name="ImageCount"
                  readonly
                  class="form-control readonly-input"
                  aria-describedby="imageCountHelp"
                >
              </div>
              
              <!-- Web Category -->
              <div class="form-group">
                <label for="popupWebCategory">Web Category</label>
                <small id="webCategoryHelp" class="form-text">Display in additional Web Category</small>
                <input
                  type="text"
                  id="popupWebCategory"
                  name="D_WebCategory"
                  class="form-control"
                  aria-describedby="webCategoryHelp"
                >
              </div>
              
              <!-- Web Status -->
              <div class="form-group">
                <label for="popupWebStatus">Web Status <span class="required">*</span></label>
                <small id="webStatusHelp" class="form-text">Determines product visibility on the website</small>
                <select
                  id="popupWebStatus"
                  name="web_status"
                  class="form-control"
                  required
                  aria-describedby="webStatusHelp"
                >
                  <option value="">Select Status</option>
                  <option value="Available">Available</option>
                  <option value="Not Available">Not Available</option>
                </select>
              </div>
            </div>
            
            <!-- Right Column: Dynamic Fields -->
            <div class="form-column form-column-dynamic">
              <div id="popupFirstColumn"></div>
              <div id="popupSecondColumn"></div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button
          type="button"
          class="btn-cancel"
          onclick="closeEditForm()"
          aria-label="Cancel edit"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="btn-submit"
          form="editProductFormContainer"
          aria-label="Save product changes"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</main>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="footer-container">
      <p class="footer-copyright">
        PADDY &copy; 2025 - IFM
      </p>
      <p class="footer-tagline">
        "Product Attribute Designer Deployment (for) You"
      </p>
      <p class="footer-version">
        "v0.4"
      </p>
    </div>
  </footer>

  <!-- Success Popup -->
  <div
    id="successPopup"
    class="popup popup-success"
    role="alert"
    aria-live="assertive"
  >
    <span
      class="popup-icon"
      aria-hidden="true"
    >
      ✓
    </span>
    <span class="popup-message">
      Success!
    </span>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/products.js') }}"></script>

  <!-- Inline Script to Remove No-JS Message -->
  <script>
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');
  </script>
</body>
</html>