<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PADDY - Products</title>

    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Liter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Our Custom Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/paddy.css') }}">
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">PADDY</a>
            <div>
                <button class="btn-uni me-2" onclick="exportTableToCSV()">Export to CSV</button>
                <button class="btn-uni" onclick="window.location.href='/'">Back to Categories</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Search Container -->
        <div class="container">
            <div class="search-container">
                <input type="text" class="search-input" id="productSearch" placeholder="Search products...">
                <button class="search-button" onclick="searchProducts()">Search</button>
            </div>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <!-- Header with Category Info and Pagination -->
            <h4 class="text-center">
                {{ category.Description }} ({{ category.Code }})
                <div class="pagination-container">
                    {% if products.CurrentPage > 1 %}
                        <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage-1, sort=current_sort) }}" class="pagination-arrow">⬅️</a>
                    {% endif %}
                    
                    {% set start_item = (products.CurrentPage - 1) * products.ItemsPerPage + 1 %}
                    {% set end_item = [products.CurrentPage * products.ItemsPerPage, products.TotalCount] | min %}
                    <span class="pagination-count">{{ start_item }}-{{ end_item }}/{{ products.TotalCount }}</span>
                    
                    {% if products.CurrentPage < products.TotalPages %}
                        <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage+1, sort=current_sort) }}" class="pagination-arrow">➡️</a>
                    {% endif %}
                </div>
            </h4>

            <!-- Table Content -->
            <div class="table-responsive">
                <table class="table table-bordered" id="productsTable">
                    <!-- Table Headers -->
                    <thead>
                        <tr>
                            <!-- Code Column -->
                            <th class="{{ 'current-sort ' + ('asc' if current_sort == '(Code)[asc]' else 'dsc' if current_sort == '(Code)[dsc]' else '') }}">
                                <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='(Code)[' + ('dsc' if current_sort == '(Code)[asc]' else 'asc') + ']') }}">Code</a>
                                <div class="resizer" data-column="0"></div>
                            </th>

                            <!-- Description Column -->
                            <th class="{{ 'current-sort ' + ('asc' if current_sort == '(Description)[asc]' else 'dsc' if current_sort == '(Description)[dsc]' else '') }}">
                                <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='(Description)[' + ('dsc' if current_sort == '(Description)[asc]' else 'asc') + ']') }}">Product Name</a>
                                <div class="resizer" data-column="1"></div>
                            </th>

                            <!-- Dynamic Fields Columns -->
                            {% for field in active_fields %}
                                <th class="{{ 'current-sort ' + ('asc' if current_sort == '(' + field.field + ')[asc]' else 'dsc' if current_sort == '(' + field.field + ')[dsc]' else '') }}">
                                    <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='(' + field.field + ')[' + ('dsc' if current_sort == '(' + field.field + ')[asc]' else 'asc') + ']') }}">{{ field.display }}</a>
                                    <div class="resizer" data-column="{{ loop.index + 2 }}"></div>
                                </th>
                            {% endfor %}

                            <!-- Web Category Column -->
                            <th class="{{ 'current-sort ' + ('asc' if current_sort == '(D_WebCategory)[asc]' else 'dsc' if current_sort == '(D_WebCategory)[dsc]' else '') }}">
                                <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='(D_WebCategory)[' + ('dsc' if current_sort == '(D_WebCategory)[asc]' else 'asc') + ']') }}">Web Category</a>
                                <div class="resizer" data-column="{{ active_fields|length + 3 }}"></div>
                            </th>

                            <!-- Image Count Column -->
                            <th class="{{ 'current-sort ' + ('asc' if current_sort == '(ImageCount)[asc]' else 'dsc' if current_sort == '(ImageCount)[dsc]' else '') }}">
                                <a href="{{ url_for('products', category_id=category.ID, page=products.CurrentPage, sort='(ImageCount)[' + ('dsc' if current_sort == '(ImageCount)[asc]' else 'asc') + ']') }}">Image Count</a>
                                <div class="resizer" data-column="{{ active_fields|length + 3 }}"></div>
                            </th>
                            <!-- Edit Column -->
                            <th>Actions</th>
                        </tr>
                    </thead>

                    <!-- Table Body -->
                    <tbody>
                        <!-- Add this inside the <tbody> where the product rows are defined -->
                        {% for product in products.Data %}
                            <tr class="product-row" data-product-id="{{ product.ID }}">
                                <td>{{ product.Code }}</td>
                                <td data-full-text="{{ product.Description }}">{{ product.Description }}</td>
                                {% for field in active_fields %}
                                    <td data-full-text="{{ product[field.field] if product[field.field] else 'N/A' }}">
                                        {{ product[field.field] if product[field.field] else 'N/A' }}
                                    </td>
                                {% endfor %}
                                <td data-full-text="{{ product.D_WebCategory if product.D_WebCategory else 'N/A' }}">
                                    {{ product.D_WebCategory if product.D_WebCategory else 'N/A' }}
                                </td>
                                <td data-full-text="{{ product.ImageCount if product.ImageCount else 'N/A' }}">
                                    {{ product.ImageCount if product.ImageCount else 'N/A' }}
                                </td>
                                <td>
                                    <button class="btn-uni edit-product-btn" data-product-id="{{ product.ID }}">
                                        Edit Product
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Edit Product Popup Form -->
        <div class="form-popup-overlay" id="editFormOverlay"></div>
        <div class="form-popup" id="editProductForm" role="dialog" aria-labelledby="editFormTitle" aria-modal="true">
            <form class="form-container">
                
                <!-- Form Header -->
                <div class="form-header">
                    <h2 id="editFormTitle">Edit Product</h2>
                    <button type="button" class="close-button" onclick="closeEditForm()" aria-label="Close">×</button>
                </div>
                
                <div class="row">
                    <!-- Current Product Details Column -->
                    <div class="col-6">
                        <h6>Current Product Details</h6>
                        <div id="currentProductDetails" role="region" aria-label="Current product information"></div>
                    </div>
                    
                    <!-- Edit Product Column -->
                    <div class="col-6">
                        <h6>Update Product Details</h6>
                        
                        <!-- Product ID (hidden) -->
                        <input type="hidden" id="popupProductId" name="product_id">
                        
                        <!-- Basic Product Information -->
                        <div class="form-group">
                            <label for="popupProductCode"><b>Update Product Code</b></label>
                            <input type="text" 
                                id="popupProductCode" 
                                name="Code" 
                                placeholder="Leave blank to keep current code"
                                aria-label="Update Product Code">
                        </div>
                        
                        <div class="form-group">
                            <label for="popupProductDescription"><b>Update Description</b></label>
                            <input type="text" 
                                id="popupProductDescription" 
                                name="Description" 
                                placeholder="Leave blank to keep current description"
                                aria-label="Update Product Description">
                        </div>
                        
                        <!-- Dynamic Fields Container -->
                        <div id="popupDynamicFields" role="region" aria-label="Additional product fields"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn" aria-label="Save product changes">Save Changes</button>
                    <button type="button" class="btn cancel" onclick="closeEditForm()" aria-label="Cancel editing">Cancel</button>
                </div>
            </form>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>PADDY &copy; 2025 - IFM</p>
        <p class="quote">"Product Attribute Designer Deployment (for) You"</p>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/products.js') }}"></script>

    <!-- Success Popup -->
    <div id="successPopup" class="success-popup">
        <div class="success-icon">✓</div>
        <div class="success-content">Success!</div>
    </div>
</body>
</html>